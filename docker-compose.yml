# ============================================
# OpenCode WebUI - Docker Compose
# ============================================
#
# 架构:
#   frontend (Caddy)  :3000 -> 静态文件 (GitHub Actions 预构建镜像)
#   backend  (opencode):4096 -> opencode serve (GitHub Actions 预构建镜像)
#
# 使用方法:
#   cp .env.example .env    # 填写 API Key
#   docker compose up -d    # 启动
#
# 本地构建前端 (可选):
#   docker compose -f docker-compose.yml -f docker-compose.build.yml up -d

services:
  # ---- 前端：预构建镜像 ----
  frontend:
    image: ghcr.io/lehhair/opencodeui-frontend:latest
    container_name: opencode-frontend
    restart: unless-stopped
    ports:
      - "127.0.0.1:${FRONTEND_PORT:-3000}:3000"

  # ---- 后端：预构建镜像 ----
  backend:
    image: ghcr.io/lehhair/opencodeui-backend:latest
    container_name: opencode-backend
    restart: unless-stopped
    ports:
      - "127.0.0.1:${API_PORT:-4096}:4096"
    deploy:
      resources:
        limits:
          memory: 4G
    volumes:
      - ${WORKSPACE:-./workspace}:/workspace
      - opencode-data:/root/.local/share/opencode
      - opencode-config:/root/.config/opencode
    working_dir: /workspace
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY:-}
      - GROQ_API_KEY=${GROQ_API_KEY:-}
      - MISTRAL_API_KEY=${MISTRAL_API_KEY:-}
      - XAI_API_KEY=${XAI_API_KEY:-}
      - OPENCODE_SERVER_PASSWORD=${OPENCODE_SERVER_PASSWORD:-}
      - OPENCODE_SERVER_USERNAME=${OPENCODE_SERVER_USERNAME:-opencode}

volumes:
  opencode-data:
  opencode-config:
